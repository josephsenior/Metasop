{
  "step_id": "engineer_impl",
  "role": "Engineer",
  "timestamp": "2026-02-07T20:27:20.927Z",
  "content": {
    "summary": "A monorepo-based, offline-first platform using React Native with WatermelonDB for POS resilience and NestJS with WebSockets for sub-200ms KDS synchronization.",
    "description": "The solution utilizes a Turborepo structure to share types and logic between the React Native POS, React KDS, and NestJS backend. The architecture centers on an 'Offline-First' approach for the POS using WatermelonDB and UUIDv7 to allow continuous operation during internet outages. Real-time updates are handled via a Redis-backed Socket.io cluster to ensure the kitchen receives orders instantly. The backend follows a modular monolith pattern to balance separation of concerns with deployment simplicity on AWS ECS.",
    "artifact_path": "restaurant-platform",
    "implementation_plan_phases": [
      {
        "name": "Phase 1: Foundation & Infrastructure",
        "description": "Setup monorepo, database schema, authentication, and core backend services.",
        "tasks": [
          "Initialize Turborepo with NestJS and React apps",
          "Provision PostgreSQL and Redis via Docker",
          "Implement UUIDv7 schema and migrations",
          "Setup Auth0 integration and JWT guards"
        ]
      },
      {
        "name": "Phase 2: POS Offline Engine",
        "description": "Develop the tablet POS with local-first data architecture.",
        "tasks": [
          "Configure WatermelonDB schema on React Native",
          "Implement offline order creation logic",
          "Build background sync mechanism with backend",
          "Create menu selection UI with modifiers"
        ]
      },
      {
        "name": "Phase 3: Real-time KDS",
        "description": "Build the Kitchen Display System with WebSocket synchronization.",
        "tasks": [
          "Implement Socket.io gateway in NestJS",
          "Create Redis Pub/Sub adapter for events",
          "Build KDS Kanban board UI",
          "Implement order bumping and status updates"
        ]
      },
      {
        "name": "Phase 4: Management & Polish",
        "description": "Table management, analytics, and production hardening.",
        "tasks": [
          "Develop drag-and-drop floor plan editor",
          "Implement bill splitting logic",
          "Configure AWS ECS and RDS pipelines",
          "Conduct load testing for WebSocket concurrency"
        ]
      }
    ],
    "state_management": {
      "tool": "WatermelonDB & React Query",
      "strategy": "POS uses local DB (Watermelon) for all data. KDS uses React Query for server state + Socket events for live updates."
    },
    "file_structure": {
      "name": "restaurant-platform",
      "type": "directory",
      "children": [
        {
          "name": "apps",
          "type": "directory",
          "children": [
            {
              "name": "api",
              "type": "directory",
              "children": [
                {
                  "name": "src",
                  "type": "directory"
                },
                {
                  "name": "test",
                  "type": "directory"
                },
                {
                  "name": "Dockerfile",
                  "type": "file"
                }
              ]
            },
            {
              "name": "pos-tablet",
              "type": "directory",
              "children": [
                {
                  "name": "src",
                  "type": "directory"
                },
                {
                  "name": "ios",
                  "type": "directory"
                },
                {
                  "name": "android",
                  "type": "directory"
                }
              ]
            },
            {
              "name": "kds-web",
              "type": "directory",
              "children": [
                {
                  "name": "src",
                  "type": "directory"
                },
                {
                  "name": "public",
                  "type": "directory"
                }
              ]
            }
          ]
        },
        {
          "name": "packages",
          "type": "directory",
          "children": [
            {
              "name": "shared-types",
              "type": "directory",
              "children": [
                {
                  "name": "index.ts",
                  "type": "file"
                }
              ]
            },
            {
              "name": "ui-kit",
              "type": "directory",
              "children": [
                {
                  "name": "components",
                  "type": "directory"
                }
              ]
            }
          ]
        },
        {
          "name": "docker-compose.yml",
          "type": "file"
        },
        {
          "name": "turbo.json",
          "type": "file"
        },
        {
          "name": "package.json",
          "type": "file"
        }
      ]
    },
    "technical_patterns": [
      "Repository Pattern",
      "Observer Pattern",
      "Adapter Pattern",
      "Offline Sync"
    ],
    "technical_decisions": [
      {
        "decision": "Use WatermelonDB for POS",
        "rationale": "Provides high-performance local SQLite wrapper with built-in sync primitives, essential for the 'offline-first' requirement.",
        "alternatives": "Redux Persist (too slow for large datasets), Realm (licensing/complexity)."
      },
      {
        "decision": "UUIDv7 for Primary Keys",
        "rationale": "Allows offline ID generation on tablets that is time-sortable, preventing index fragmentation and sync collisions.",
        "alternatives": "UUIDv4 (bad index performance), Auto-increment (impossible offline)."
      },
      {
        "decision": "NestJS with Socket.io",
        "rationale": "Provides a structured, scalable framework for handling both REST APIs and stateful WebSocket connections in a single codebase.",
        "alternatives": "Express (too loose), Fastify (good but less ecosystem for sockets)."
      },
      {
        "decision": "Turborepo Monorepo",
        "rationale": "Ensures type safety across the stack by sharing DTOs and interfaces between the API, POS, and KDS apps.",
        "alternatives": "Polyrepo (code duplication, sync issues)."
      }
    ],
    "environment_variables": [
      {
        "name": "DATABASE_URL",
        "description": "PostgreSQL connection string.",
        "example": "postgresql://user:pass@localhost:5432/db",
        "required": true
      },
      {
        "name": "REDIS_URL",
        "description": "Redis connection for Pub/Sub and caching.",
        "example": "redis://localhost:6379",
        "required": true
      },
      {
        "name": "JWT_SECRET",
        "description": "Secret key for signing auth tokens.",
        "example": "super-secret-key-change-me",
        "required": true
      },
      {
        "name": "STRIPE_SECRET_KEY",
        "description": "API key for payment processing.",
        "example": "sk_test_...",
        "required": true
      }
    ],
    "dependencies": [
      "react@18.2.0",
      "react-native@0.73.0",
      "@nestjs/core@10.3.0",
      "@nestjs/websockets@10.3.0",
      "socket.io-client@4.7.0",
      "@nozbe/watermelondb@0.27.0",
      "pg@8.11.0",
      "typeorm@0.3.20",
      "redis@4.6.0",
      "@tanstack/react-query@5.0.0",
      "tailwindcss@3.4.0",
      "zod@3.22.0",
      "uuid@9.0.0"
    ],
    "run_results": {
      "setup_commands": [
        "pnpm install",
        "docker-compose up -d",
        "pnpm db:migrate"
      ],
      "test_commands": [
        "pnpm test",
        "pnpm test:e2e"
      ],
      "dev_commands": [
        "pnpm dev",
        "pnpm --filter api dev"
      ],
      "build_commands": [
        "pnpm build",
        "pnpm type-check"
      ],
      "notes": "Ensure Docker is running for local DB/Redis. POS requires iOS/Android simulator."
    }
  }
}