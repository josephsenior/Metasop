{
  "step_id": "qa_verification",
  "role": "QA",
  "timestamp": "2026-02-07T20:27:51.772Z",
  "content": {
    "ok": true,
    "test_strategy": {
      "unit": "Vitest for logic (pricing, bill splitting) and WatermelonDB models. React Testing Library for UI components. Mocking: MSW for network, factory-js for data entities. Target: 90% on core logic.",
      "integration": "Supertest for NestJS API endpoints. Testcontainers (Postgres/Redis) for DB/Cache interactions. Focus on WebSocket event emission and UUIDv7 generation uniqueness.",
      "e2e": "Playwright for critical paths: Order Entry -> Sync -> KDS Display. Custom fixtures to simulate offline/online network states. Runs on staging with seeded data.",
      "approach": "Heavy emphasis on Unit/Integration due to complex business logic (taxes, modifiers). E2E focuses on the 'Sync Engine' and Real-time WebSocket reliability across devices.",
      "tools": [
        "Vitest",
        "Playwright",
        "Supertest",
        "k6",
        "Testcontainers",
        "MSW"
      ],
      "types": [
        "unit",
        "integration",
        "e2e",
        "performance",
        "security",
        "accessibility"
      ]
    },
    "test_cases": [
      {
        "id": "TC-001",
        "title": "Digital Order Submission (Online)",
        "expected_result": "201 Created, WebSocket event broadcasted to KDS room",
        "type": "e2e",
        "priority": "high",
        "description": "Server submits order with modifiers via POS. Verify API response and immediate appearance on KDS screen via WebSocket."
      },
      {
        "id": "TC-002",
        "title": "Offline Order Queuing & Sync",
        "expected_result": "Order stored locally, synced automatically upon reconnection",
        "type": "e2e",
        "priority": "high",
        "description": "Disable network on POS. Create order. Verify local DB persistence. Re-enable network. Verify background sync POSTs data to backend."
      },
      {
        "id": "TC-003",
        "title": "Bill Splitting Calculation",
        "expected_result": "Split totals equal original total exactly (no rounding errors)",
        "type": "unit",
        "priority": "medium",
        "description": "Unit test splitting a $100.00 check 3 ways. Verify handling of remainder cents and tax distribution logic."
      },
      {
        "id": "TC-004",
        "title": "KDS Order Bumping",
        "expected_result": "Status updates to 'READY', POS receives notification",
        "type": "integration",
        "priority": "high",
        "description": "Send PATCH /orders/{id}/status. Verify DB update and Redis Pub/Sub event triggers update on POS client."
      },
      {
        "id": "TC-005",
        "title": "Menu Item 86 (Out of Stock)",
        "expected_result": "Item disabled on all POS terminals immediately",
        "type": "e2e",
        "priority": "medium",
        "description": "Manager marks item out of stock in Admin. Verify POS prevents selection of that item within 2 seconds."
      },
      {
        "id": "TC-006",
        "title": "Tenant Isolation (RLS)",
        "expected_result": "Query returns 0 records for other tenant's ID",
        "type": "integration",
        "priority": "high",
        "description": "Attempt to fetch orders using a valid JWT but requesting data belonging to a different restaurant_id."
      },
      {
        "id": "TC-007",
        "title": "WebSocket Load Stability",
        "expected_result": "Latency < 200ms at 500 concurrent connections",
        "type": "manual",
        "priority": "high",
        "description": "Use k6 to simulate 500 connected KDS clients receiving order events simultaneously."
      }
    ],
    "security_plan": {
      "auth_verification_steps": [
        "Verify JWT signature and expiration on every API call",
        "Test refresh token rotation mechanism on POS tablets",
        "Validate Row-Level Security policies prevent cross-tenant data access",
        "Check role-based access (Server cannot access Admin Menu Config)"
      ],
      "vulnerability_scan_strategy": "Weekly OWASP ZAP scans on staging API. Snyk scans on every PR for dependency vulnerabilities."
    },
    "manual_verification_steps": [
      "Verify physical receipt printer integration triggers on 'Bill' action",
      "Test tablet responsiveness in actual kitchen lighting (Dark Mode)",
      "Simulate Wi-Fi drop/reconnect during active transaction",
      "Verify touch targets on 10-inch tablet are easily tappable"
    ],
    "risk_analysis": [
      {
        "risk": "Offline Sync Conflicts",
        "impact": "high",
        "mitigation": "Strict UUIDv7 usage and 'Last-Write-Wins' logic tests."
      },
      {
        "risk": "WebSocket Message Loss",
        "impact": "high",
        "mitigation": "Implement application-level ACKs for critical KDS events."
      },
      {
        "risk": "Decimal Rounding Errors",
        "impact": "medium",
        "mitigation": "Use integer math (cents) for all monetary values in Unit tests."
      }
    ],
    "summary": "A hybrid testing strategy combining rigorous Unit testing for financial logic and offline-first data models, with targeted E2E tests validating the critical real-time synchronization loop between POS and KDS.",
    "description": "The QA plan prioritizes the system's ability to handle network instability and high-concurrency real-time events. Given the 'Offline-First' architecture using WatermelonDB, extensive integration testing will focus on the synchronization engine and UUIDv7 collision avoidance. Performance testing is critical to ensure the <200ms latency requirement is met via WebSockets. Security testing focuses on multi-tenant isolation via RLS.",
    "coverage": {
      "percentage": 80,
      "threshold": 80,
      "lines": 80,
      "statements": 80,
      "functions": 85,
      "branches": 75
    },
    "performance_metrics": {
      "api_response_time_p95": "200ms",
      "page_load_time": "2.0s",
      "database_query_time": "50ms",
      "first_contentful_paint": "1.5s",
      "time_to_interactive": "2.5s",
      "largest_contentful_paint": "2.5s"
    },
    "accessibility_plan": {
      "automated_tools": [
        "axe-core",
        "Lighthouse"
      ],
      "manual_checks": [
        "Color contrast in KDS Dark Mode",
        "Touch target size (>44px) for POS",
        "Screen reader announcements for new orders"
      ],
      "screen_readers": [
        "VoiceOver",
        "TalkBack"
      ],
      "standard": "WCAG 2.1 AA"
    },
    "manual_uat_plan": {
      "acceptance_criteria": [
        "Server can take an order in < 30 seconds",
        "Kitchen sees order in < 2 seconds",
        "Bill splitting works for groups of 4+"
      ],
      "scenarios": [
        "Full Dinner Service: Seat -> Order -> Cook -> Serve -> Split Bill -> Pay",
        "Kitchen Rush: 20 orders arriving within 1 minute",
        "Manager updates menu price while service is active"
      ],
      "stakeholders": [
        "Restaurant Owner",
        "Head Chef",
        "Lead Server"
      ]
    }
  }
}