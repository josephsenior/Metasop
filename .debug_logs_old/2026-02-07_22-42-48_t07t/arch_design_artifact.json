{
  "step_id": "arch_design",
  "role": "Architect",
  "timestamp": "2026-02-07T21:44:20.401Z",
  "content": {
    "design_doc": "## System Overview\nThe Restaurant Management Platform is a cloud-native, distributed system designed to facilitate real-time operations between the Front of House (FOH) and Back of House (BOH). The architecture follows a client-server model with a heavy emphasis on real-time event propagation using WebSockets to ensure the Kitchen Display System (KDS) reflects orders immediately upon submission.\n\n## Architecture Components\n1. **Client Layer**: \n   - **POS Tablet App**: A React-based Single Page Application (SPA) optimized for touch interfaces. Handles order entry, table management, and payment processing.\n   - **Kitchen Display System (KDS)**: A specialized view within the SPA that listens for 'order_created' and 'order_updated' events via WebSockets.\n\n2. **API Gateway / Load Balancer**: AWS Application Load Balancer (ALB) terminates SSL and routes traffic to the backend services.\n\n3. **Backend Services**: \n   - **Core API Service**: A Node.js/NestJS monolith (modularized) handling RESTful requests for menu management, order processing, and reporting. \n   - **Real-time Service**: A Socket.io server integrated with the Core API to broadcast order state changes to connected KDS clients.\n\n4. **Data Layer**: \n   - **Primary Database**: PostgreSQL for relational data (users, menu, orders, transactions). ACID compliance is strictly enforced for financial integrity.\n   - **Cache**: Redis for caching menu configurations and managing WebSocket session state.\n\n## Data Flow\n1. **Order Entry**: Server creates an order (Draft status) via REST API. Data is persisted to Postgres.\n2. **Submission**: Server triggers 'Send to Kitchen'. API updates status to 'Pending', commits transaction, and emits a WebSocket event.\n3. **Kitchen Update**: KDS clients receive the event payload and update the UI instantly without polling.\n4. **Payment**: Payment intent is generated via Stripe. Webhook confirms success, API updates order to 'Closed', and releases the table.\n\n## Cross-Cutting Concerns\n- **Observability**: Structured logging via Winston/CloudWatch. APM via Datadog.\n- **Security**: JWT-based authentication via Auth0. Role-Based Access Control (RBAC) middleware ensures Servers cannot access Admin reporting.\n- **Resilience**: Circuit breakers on payment gateway integration. Automatic retries for database connections.",
    "apis": [
      {
        "path": "/api/v1/menu-items",
        "method": "GET",
        "description": "Retrieve active menu items for POS selection.",
        "request_schema": {
          "value": "category_id"
        },
        "response_schema": {
          "value": "items"
        },
        "auth_required": true,
        "rate_limit": "100 req/min"
      },
      {
        "path": "/api/v1/orders",
        "method": "POST",
        "description": "Create a new order or add items to existing order.",
        "request_schema": {
          "value": "tableId"
        },
        "response_schema": {
          "value": "id"
        },
        "auth_required": true,
        "rate_limit": "50 req/min"
      },
      {
        "path": "/api/v1/orders/{id}/status",
        "method": "PATCH",
        "description": "Update order status (e.g., Send to Kitchen).",
        "request_schema": {
          "value": "status"
        },
        "response_schema": {
          "value": "id"
        },
        "auth_required": true,
        "rate_limit": "50 req/min"
      },
      {
        "path": "/api/v1/payments",
        "method": "POST",
        "description": "Process payment for an order.",
        "request_schema": {
          "value": "orderId"
        },
        "response_schema": {
          "value": "transactionId"
        },
        "auth_required": true,
        "rate_limit": "20 req/min"
      },
      {
        "path": "/api/v1/reports/daily-sales",
        "method": "GET",
        "description": "Get aggregated sales data for the day.",
        "request_schema": {
          "value": "date"
        },
        "response_schema": {
          "value": "totalRevenue"
        },
        "auth_required": true,
        "rate_limit": "10 req/min"
      }
    ],
    "summary": "A cloud-native POS system leveraging React, NestJS, and PostgreSQL. It features real-time kitchen updates via WebSockets and secure payment processing via Stripe, deployed on AWS for reliability.",
    "description": "This architecture provides a robust platform for single-location restaurants. It separates concerns between the Point of Sale (FOH) and Kitchen Display System (BOH) while keeping them synchronized in real-time. The system uses a relational database to ensure financial data integrity and employs a stateless backend design to facilitate easy horizontal scaling during peak hours.",
    "decisions": [
      {
        "decision": "Use PostgreSQL as primary database",
        "status": "accepted",
        "reason": "ACID compliance is non-negotiable for financial transactions and inventory integrity. Relational model fits the structured nature of menus and orders.",
        "tradeoffs": "Schema migrations can be painful compared to NoSQL; slightly higher setup complexity.",
        "consequences": "Must implement strict migration pipelines (e.g., TypeORM/Prisma migrations).",
        "alternatives": [
          "MongoDB (rejected: lack of multi-document transactions in older versions, eventual consistency risks)",
          "Firebase Realtime DB (rejected: poor complex querying capabilities for reports)"
        ]
      },
      {
        "decision": "Use WebSockets (Socket.io) for Kitchen Display",
        "status": "accepted",
        "reason": "Polling introduces unnecessary latency and server load. Kitchen staff need sub-second updates when orders are submitted.",
        "tradeoffs": "Requires maintaining stateful connections; scaling requires Redis adapter for pub/sub.",
        "consequences": "Need to provision Redis infrastructure and handle reconnection logic on the frontend.",
        "alternatives": [
          "Short Polling (rejected: high server load, latency)",
          "Server-Sent Events (considered: good for one-way, but WebSockets allow bi-directional future proofing)"
        ]
      },
      {
        "decision": "Use Auth0 for Identity Management",
        "status": "accepted",
        "reason": "Offloads complex security requirements (MFA, session management, RBAC) to a managed provider. Speeds up development.",
        "tradeoffs": "Vendor lock-in; cost scales with active users (though low for single restaurant staff).",
        "consequences": "Backend must validate JWTs against Auth0 public keys.",
        "alternatives": [
          "Custom JWT implementation (rejected: security risk, maintenance burden)",
          "AWS Cognito (rejected: poor developer experience compared to Auth0)"
        ]
      }
    ],
    "database_schema": {
      "tables": [
        {
          "name": "users",
          "columns": [
            {
              "name": "id",
              "type": "UUID",
              "constraints": [
                "PRIMARY KEY"
              ],
              "description": "Unique identifier"
            },
            {
              "name": "email",
              "type": "VARCHAR(255)",
              "constraints": [
                "UNIQUE",
                "NOT NULL"
              ],
              "description": "Staff email"
            },
            {
              "name": "role",
              "type": "VARCHAR(20)",
              "constraints": [
                "NOT NULL"
              ],
              "description": "admin, server, kitchen"
            }
          ],
          "description": "Staff members with access to the system",
          "indexes": [
            {
              "columns": [
                "email"
              ],
              "type": "btree"
            }
          ],
          "relationships": []
        },
        {
          "name": "menu_categories",
          "columns": [
            {
              "name": "id",
              "type": "UUID",
              "constraints": [
                "PRIMARY KEY"
              ],
              "description": "Unique identifier"
            },
            {
              "name": "name",
              "type": "VARCHAR(50)",
              "constraints": [
                "NOT NULL"
              ],
              "description": "e.g. Appetizers"
            },
            {
              "name": "sort_order",
              "type": "INTEGER",
              "constraints": [
                "DEFAULT 0"
              ],
              "description": "Display order"
            }
          ],
          "description": "High level menu grouping",
          "indexes": [],
          "relationships": []
        },
        {
          "name": "menu_items",
          "columns": [
            {
              "name": "id",
              "type": "UUID",
              "constraints": [
                "PRIMARY KEY"
              ],
              "description": "Unique identifier"
            },
            {
              "name": "category_id",
              "type": "UUID",
              "constraints": [
                "NOT NULL"
              ],
              "description": "FK to menu_categories"
            },
            {
              "name": "name",
              "type": "VARCHAR(100)",
              "constraints": [
                "NOT NULL"
              ],
              "description": "Item name"
            },
            {
              "name": "price",
              "type": "DECIMAL(10,2)",
              "constraints": [
                "NOT NULL"
              ],
              "description": "Unit price"
            },
            {
              "name": "is_available",
              "type": "BOOLEAN",
              "constraints": [
                "DEFAULT TRUE"
              ],
              "description": "86 status"
            }
          ],
          "description": "Individual sellable items",
          "indexes": [
            {
              "columns": [
                "category_id"
              ],
              "type": "btree"
            }
          ],
          "relationships": [
            {
              "type": "many-to-one",
              "from": "category_id",
              "to": "menu_categories.id"
            }
          ]
        },
        {
          "name": "orders",
          "columns": [
            {
              "name": "id",
              "type": "UUID",
              "constraints": [
                "PRIMARY KEY"
              ],
              "description": "Unique identifier"
            },
            {
              "name": "table_number",
              "type": "VARCHAR(10)",
              "constraints": [
                "NOT NULL"
              ],
              "description": "Physical table ID"
            },
            {
              "name": "status",
              "type": "VARCHAR(20)",
              "constraints": [
                "NOT NULL"
              ],
              "description": "draft, pending, served, closed"
            },
            {
              "name": "total_amount",
              "type": "DECIMAL(10,2)",
              "constraints": [
                "DEFAULT 0"
              ],
              "description": "Cached total"
            },
            {
              "name": "created_at",
              "type": "TIMESTAMP",
              "constraints": [
                "DEFAULT NOW()"
              ],
              "description": "Creation time"
            }
          ],
          "description": "Customer orders",
          "indexes": [
            {
              "columns": [
                "status",
                "created_at"
              ],
              "type": "btree"
            }
          ],
          "relationships": []
        },
        {
          "name": "order_items",
          "columns": [
            {
              "name": "id",
              "type": "UUID",
              "constraints": [
                "PRIMARY KEY"
              ],
              "description": "Unique identifier"
            },
            {
              "name": "order_id",
              "type": "UUID",
              "constraints": [
                "NOT NULL"
              ],
              "description": "FK to orders"
            },
            {
              "name": "menu_item_id",
              "type": "UUID",
              "constraints": [
                "NOT NULL"
              ],
              "description": "FK to menu_items"
            },
            {
              "name": "quantity",
              "type": "INTEGER",
              "constraints": [
                "NOT NULL",
                "CHECK > 0"
              ],
              "description": "Count"
            },
            {
              "name": "notes",
              "type": "VARCHAR(255)",
              "constraints": [],
              "description": "Special instructions"
            }
          ],
          "description": "Line items within an order",
          "indexes": [
            {
              "columns": [
                "order_id"
              ],
              "type": "btree"
            }
          ],
          "relationships": [
            {
              "type": "many-to-one",
              "from": "order_id",
              "to": "orders.id"
            },
            {
              "type": "many-to-one",
              "from": "menu_item_id",
              "to": "menu_items.id"
            }
          ]
        }
      ]
    },
    "technology_stack": {
      "frontend": [
        "React",
        "TypeScript",
        "TailwindCSS",
        "Vite",
        "Socket.io-client"
      ],
      "backend": [
        "Node.js",
        "NestJS",
        "Prisma ORM",
        "Socket.io"
      ],
      "database": [
        "PostgreSQL 15",
        "Redis (Cache/PubSub)"
      ],
      "authentication": [
        "Auth0",
        "JWT"
      ],
      "hosting": [
        "AWS ECS (Fargate)",
        "AWS RDS",
        "AWS CloudFront"
      ],
      "other": [
        "Stripe SDK",
        "Winston (Logging)",
        "Jest (Testing)"
      ]
    },
    "security_considerations": [
      "All API endpoints except health checks require valid JWT Bearer tokens.",
      "RBAC middleware enforces that only 'Admin' role can access sales reports.",
      "Order modification is locked once status is 'Pending' or 'Served'.",
      "No raw credit card data is stored; only Stripe tokens and last 4 digits.",
      "CORS policies restricted to the specific domain of the restaurant's tablet."
    ],
    "scalability_approach": {
      "horizontal_scaling": "Stateless backend services deployed on AWS ECS Fargate allow auto-scaling based on CPU/Memory usage.",
      "performance_targets": "API response < 200ms; WebSocket broadcast < 50ms; Page load < 2s on 4G."
    },
    "integration_points": [
      {
        "service": "Stripe",
        "purpose": "Payment processing and card tokenization",
        "api_docs": "https://stripe.com/docs/api"
      },
      {
        "service": "Auth0",
        "purpose": "Identity provider and token generation",
        "api_docs": "https://auth0.com/docs/api"
      },
      {
        "service": "SendGrid",
        "purpose": "Emailing daily reports to owners (optional)",
        "api_docs": "https://docs.sendgrid.com/api-reference"
      }
    ]
  }
}