{
  "step_id": "security_architecture",
  "role": "Security",
  "content": {
    "summary": "The security architecture for CryptoPulse is designed to protect high-value assets (Exchange API Keys) in a non-custodial environment. The core defense is Application-Level Envelope Encryption using AWS KMS, ensuring that even a full database compromise does not yield usable API secrets. Authentication relies on standard JWT flows hardened with MFA and HttpOnly cookies. The infrastructure leverages AWS VPC isolation to separate the public API from the sensitive Execution Engine.",
    "description": "CryptoPulse operates in a high-threat environment where user trust is paramount. The architecture adopts a 'Zero Trust' approach to data storage. \n\n1. **Identity**: Users authenticate via email/password + TOTP. Sessions are managed via secure, HTTP-only cookies to mitigate XSS token theft.\n2. **Data Protection**: The 'Crown Jewels' (Exchange API Secrets) are encrypted using a unique Data Encryption Key (DEK) for each entry. This DEK is encrypted by a Master Key (KEK) stored in AWS KMS. The application only decrypts secrets in memory within the isolated 'Execution Engine' service for the brief moment required to sign a transaction.\n3. **Network**: The Execution Engine resides in a private subnet with no direct internet ingress. It communicates outbound to exchanges via a NAT Gateway with strict egress filtering.\n4. **Resilience**: Rate limiting is applied at both the Global (WAF) and Application (Redis) layers to protect against DDoS and ensure fair usage of exchange API quotas.",
    "security_architecture": {
      "authentication": {
        "method": "JWT",
        "description": "Stateless authentication using short-lived JWT Access Tokens (15m) and long-lived Refresh Tokens (7d). Refresh tokens are rotated on use (Refresh Token Rotation) to detect theft.",
        "mfa_enabled": true,
        "multi_factor_auth": true,
        "providers": [
          "local-email-password"
        ],
        "refresh_tokens": true,
        "token_expiry": "15m"
      },
      "authorization": {
        "model": "RBAC",
        "description": "Role-Based Access Control enforcing strict resource ownership. Users can only access their own exchange connections and orders.",
        "policies": [
          {
            "resource": "exchange_connections",
            "permissions": [
              "create",
              "read",
              "update",
              "delete"
            ],
            "description": "Users manage their own exchange API keys.",
            "roles": [
              "user"
            ]
          },
          {
            "resource": "orders",
            "permissions": [
              "create",
              "read",
              "cancel"
            ],
            "description": "Users can place and cancel orders on their connected exchanges.",
            "roles": [
              "user"
            ]
          },
          {
            "resource": "system_admin",
            "permissions": [
              "view_metrics",
              "manage_users"
            ],
            "description": "Admins can view system health but cannot decrypt user API keys.",
            "roles": [
              "admin"
            ]
          }
        ],
        "roles": [
          "user",
          "admin",
          "auditor"
        ]
      },
      "session_management": {
        "http_only_cookies": true,
        "same_site_policy": "strict",
        "secure_cookies": true,
        "session_timeout": "7d",
        "strategy": "stateless"
      }
    },
    "threat_model": [
      {
        "threat": "Compromise of Exchange API Secrets (Information Disclosure)",
        "severity": "critical",
        "mitigation": "Envelope encryption using AWS KMS. Database only stores encrypted data (ciphertext); decryption occurs only in volatile memory within the isolated Execution Engine.",
        "affected_components": [
          "Database",
          "Execution Engine"
        ],
        "impact": "Attackers could drain user funds via wash trading on external exchanges.",
        "likelihood": "low"
      },
      {
        "threat": "Cross-Site Scripting (XSS) leading to Session Hijacking",
        "severity": "high",
        "mitigation": "Strict Content Security Policy (CSP), HttpOnly/Secure cookies for tokens, and sanitization of all user inputs (e.g., connection labels).",
        "affected_components": [
          "Frontend",
          "API Gateway"
        ],
        "impact": "Attacker executes trades on behalf of the logged-in user.",
        "likelihood": "medium"
      },
      {
        "threat": "Man-in-the-Middle (MitM) Attacks on API Traffic",
        "severity": "high",
        "mitigation": "Enforce TLS 1.3 for all client-server communications and strict certificate validation for backend-to-exchange connections.",
        "affected_components": [
          "API Gateway",
          "Exchange Adapter"
        ],
        "impact": "Interception of auth tokens or manipulation of trade orders in transit.",
        "likelihood": "low"
      },
      {
        "threat": "API Rate Limit Exhaustion (Denial of Service)",
        "severity": "medium",
        "mitigation": "Distributed rate limiting via Redis (Token Bucket algorithm) per user and per exchange IP to prevent upstream bans.",
        "affected_components": [
          "Exchange Adapter",
          "API Gateway"
        ],
        "impact": "System becomes unable to fetch prices or execute orders for legitimate users.",
        "likelihood": "medium"
      },
      {
        "threat": "Credential Stuffing / Brute Force",
        "severity": "medium",
        "mitigation": "Implement exponential backoff on login endpoints and require CAPTCHA after 3 failed attempts.",
        "affected_components": [
          "Auth Service"
        ],
        "impact": "Unauthorized access to user accounts.",
        "likelihood": "high"
      }
    ],
    "encryption": {
      "data_at_rest": {
        "method": "AES-256-GCM",
        "key_management": "AWS KMS (Envelope Encryption)",
        "description": "Sensitive fields (API Secrets) are encrypted at the application level before DB insertion. The Database volume is also encrypted via AWS RDS encryption."
      },
      "data_in_transit": {
        "method": "TLS 1.3",
        "certificate_management": "AWS Certificate Manager (ACM) with auto-renewal",
        "description": "All HTTP/WebSocket traffic is encrypted. Internal service-to-service communication within the VPC uses private subnets."
      },
      "key_management": {
        "strategy": "Centralized Cloud KMS",
        "description": "Master keys (KEK) never leave AWS KMS. Data Encryption Keys (DEK) are generated per user/connection, encrypted by KEK, and stored alongside data.",
        "rotation_policy": "Automatic annual rotation of Customer Master Keys (CMK)."
      },
      "envelope_encryption": true,
      "secrets_management": "AWS Secrets Manager for application infrastructure secrets (DB credentials, 3rd party API keys)."
    },
    "compliance": [
      {
        "standard": "GDPR",
        "requirements": [
          "Right to be Forgotten",
          "Data Portability",
          "Consent Management"
        ],
        "description": "Ensure EU users can request deletion of their account and all associated data (including API keys).",
        "implementation_status": "planned"
      },
      {
        "standard": "SOC2",
        "requirements": [
          "Access Control",
          "Change Management",
          "System Operations"
        ],
        "description": "Future target for enterprise readiness; currently implementing logging and access controls to align with Trust Services Criteria.",
        "implementation_status": "planned"
      }
    ],
    "security_controls": [
      {
        "control": "Web Application Firewall (WAF)",
        "implementation": "AWS WAF configured with rules to block SQL injection, XSS patterns, and known malicious IP addresses.",
        "category": "preventive",
        "priority": "high"
      },
      {
        "control": "Strict Content Security Policy (CSP)",
        "implementation": "HTTP Header configuration preventing execution of inline scripts and restricting resource loading to trusted domains.",
        "category": "preventive",
        "priority": "high"
      },
      {
        "control": "Two-Factor Authentication (TOTP)",
        "implementation": "Mandatory for critical actions (API Key deletion, Password change) and optional for login.",
        "category": "preventive",
        "priority": "critical"
      },
      {
        "control": "Audit Logging",
        "implementation": "Immutable logs of all 'Trade' and 'Auth' events, stored in S3 with Object Lock (WORM compliance).",
        "category": "detective",
        "priority": "medium"
      },
      {
        "control": "Dependency Scanning",
        "implementation": "Automated Snyk scans in CI/CD pipeline to block builds with critical vulnerabilities in npm packages.",
        "category": "preventive",
        "priority": "high"
      }
    ],
    "vulnerability_management": {
      "patch_management": "Automated dependency updates via Dependabot; Critical OS patches applied within 48h via AWS Systems Manager.",
      "scanning_frequency": "Continuous (CI/CD) + Weekly Static Analysis",
      "tools": [
        "Snyk (SCA)",
        "SonarQube (SAST)",
        "OWASP ZAP (DAST)"
      ]
    },
    "security_monitoring": {
      "incident_response_plan": "Playbooks defined for 'API Key Leak', 'DDoS', and 'Exchange Outage'. On-call rotation established via PagerDuty.",
      "log_retention": "90 days hot storage (CloudWatch), 1 year cold storage (S3 Glacier)",
      "tools": [
        "AWS GuardDuty (Threat Detection)",
        "AWS CloudTrail (API Auditing)",
        "ELK Stack (Log Aggregation)"
      ]
    }
  }
}