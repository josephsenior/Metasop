{
  "step_id": "arch_design",
  "role": "Architect",
  "timestamp": "2026-01-20T01:48:23.069Z",
  "content": {
    "design_doc": "# Digital Banking Architecture Design Document\n\n## 1. Overview\nThis document outlines the architecture for a secure, cross-platform digital banking application. The system is designed to provide real-time financial management, biometric authentication, and regulatory compliance using a React Native mobile client and a Node.js/PostgreSQL backend.\n\n## 2. System Architecture\nWe will adopt a **Modular Monolith** architecture initially, allowing for rapid development while maintaining clear domain boundaries (Auth, Accounts, Transfers, Notifications) that can be extracted into microservices as the user base scales.\n\n### 2.1 Mobile Client (React Native)\n- **State Management**: Redux Toolkit for predictable state updates.\n- **Security**: \n  - `react-native-keychain` for secure storage of JWTs.\n  - Biometric authentication (FaceID/TouchID) triggers a cryptographic signature sent to the backend, rather than just a local boolean check.\n- **Communication**: Axios with interceptors for automatic token refresh.\n\n### 2.2 Backend API (Node.js)\n- **Framework**: NestJS is chosen for its strict architectural patterns (Modules, Controllers, Services) and TypeScript support.\n- **API Gateway**: Nginx will handle SSL termination, rate limiting, and request routing.\n- **Business Logic**: \n  - **Transactional Integrity**: All money movements use database transactions (ACID).\n  - **Event Bus**: Redis-based event queue for asynchronous tasks like Push Notifications and Audit Logging.\n\n### 2.3 Data Layer (PostgreSQL)\n- **Schema**: Normalized relational schema (3NF).\n- **Encryption**: PII (Personally Identifiable Information) and sensitive financial data (account numbers) are encrypted at rest using `pgcrypto` or application-level AES-256 encryption.\n- **Audit**: Trigger-based audit logging for all `INSERT`, `UPDATE`, and `DELETE` operations on financial tables.\n\n## 3. Security & Compliance\n- **Authentication**: OAuth2 flow with short-lived Access Tokens and secure HTTP-only Refresh Tokens.\n- **Biometrics**: Public/Private key pair generated on device. Public key stored on server. Login involves signing a nonce with the Private key.\n- **Regulatory**: \n  - GDPR endpoints for data export/deletion.\n  - KYC status tracking in the user model.\n\n## 4. Infrastructure\n- **Containerization**: Docker for all services.\n- **Orchestration**: AWS ECS (Fargate) for scalable, serverless container management.\n- **CI/CD**: GitHub Actions pipeline running SAST (Static Application Security Testing) before deployment.",
    "apis": [
      {
        "path": "/api/v1/auth/login",
        "method": "POST",
        "description": "Authenticate user via password or biometric signature.",
        "request_schema": {
          "email": "string",
          "password": "string?",
          "biometric_signature": "string?",
          "nonce": "string?"
        },
        "response_schema": {
          "access_token": "string",
          "refresh_token": "string",
          "user": {
            "id": "uuid",
            "kyc_status": "string"
          }
        },
        "auth_required": false,
        "endpoint": "https://api.bank.com",
        "rate_limit": "5/min"
      },
      {
        "path": "/api/v1/accounts",
        "method": "GET",
        "description": "Retrieve all accounts for the authenticated user.",
        "request_schema": {},
        "response_schema": {
          "accounts": [
            {
              "id": "uuid",
              "type": "string",
              "balance": "number",
              "currency": "string"
            }
          ]
        },
        "auth_required": true,
        "endpoint": "https://api.bank.com",
        "rate_limit": "100/min"
      },
      {
        "path": "/api/v1/transfers",
        "method": "POST",
        "description": "Initiate an internal money transfer.",
        "request_schema": {
          "source_account_id": "uuid",
          "destination_account_id": "uuid",
          "amount": "number",
          "note": "string"
        },
        "response_schema": {
          "transaction_id": "uuid",
          "status": "string",
          "timestamp": "iso8601"
        },
        "auth_required": true,
        "endpoint": "https://api.bank.com",
        "rate_limit": "10/min"
      },
      {
        "path": "/api/v1/transactions",
        "method": "GET",
        "description": "Get transaction history with pagination.",
        "request_schema": {
          "account_id": "uuid",
          "page": "number",
          "limit": "number"
        },
        "response_schema": {
          "data": [
            {
              "id": "uuid",
              "amount": "number",
              "type": "string"
            }
          ],
          "total": "number"
        },
        "auth_required": true,
        "endpoint": "https://api.bank.com",
        "rate_limit": "60/min"
      },
      {
        "path": "/api/v1/savings-goals",
        "method": "POST",
        "description": "Create a new savings goal.",
        "request_schema": {
          "name": "string",
          "target_amount": "number",
          "deadline": "date"
        },
        "response_schema": {
          "id": "uuid",
          "current_amount": "number",
          "status": "active"
        },
        "auth_required": true,
        "endpoint": "https://api.bank.com",
        "rate_limit": "20/min"
      }
    ],
    "summary": "A secure, compliant digital banking platform built on React Native and Node.js/PostgreSQL, featuring biometric security, real-time ledgers, and modular architecture.",
    "description": "This architecture modernizes personal finance by combining a high-performance Node.js backend with a secure React Native mobile app. It prioritizes data integrity via ACID-compliant PostgreSQL transactions and security through biometric-backed authentication and end-to-end encryption.",
    "decisions": [
      {
        "decision": "Use PostgreSQL for Primary Database",
        "status": "accepted",
        "reason": "Banking requires strict ACID compliance for transactions which NoSQL solutions often trade for availability.",
        "rationale": "Data integrity is paramount for financial ledgers.",
        "tradeoffs": "Harder to scale horizontally compared to NoSQL; requires strict schema management.",
        "consequences": "Must implement connection pooling and careful migration strategies.",
        "alternatives": [
          "MongoDB",
          "DynamoDB"
        ]
      },
      {
        "decision": "NestJS Framework for Backend",
        "status": "accepted",
        "reason": "Provides a structured, opinionated architecture (Angular-like) suitable for enterprise Node.js apps.",
        "rationale": "Maintainability and type safety are critical for banking logic.",
        "tradeoffs": "Steeper learning curve than Express; more boilerplate code.",
        "consequences": "Team must learn Dependency Injection patterns and TypeScript decorators.",
        "alternatives": [
          "Express.js",
          "Fastify"
        ]
      },
      {
        "decision": "Biometric Signature vs Local Auth",
        "status": "accepted",
        "reason": "Local auth only proves the user passed the device lock. Signing a payload proves the user is present to the server.",
        "rationale": "Higher security standard for financial access.",
        "tradeoffs": "More complex implementation requiring public/private key management.",
        "consequences": "Need to manage device registration and key rotation.",
        "alternatives": [
          "Local Boolean Check"
        ]
      }
    ],
    "database_schema": {
      "tables": [
        {
          "name": "users",
          "columns": [
            {
              "name": "id",
              "type": "UUID",
              "constraints": [
                "PRIMARY KEY"
              ],
              "description": "Unique user identifier"
            },
            {
              "name": "email",
              "type": "VARCHAR(255)",
              "constraints": [
                "UNIQUE",
                "NOT NULL"
              ],
              "description": "User email address"
            },
            {
              "name": "password_hash",
              "type": "VARCHAR(255)",
              "constraints": [
                "NOT NULL"
              ],
              "description": "Bcrypt hash"
            },
            {
              "name": "kyc_status",
              "type": "VARCHAR(20)",
              "constraints": [
                "DEFAULT 'pending'"
              ],
              "description": "verified, pending, rejected"
            }
          ],
          "description": "Stores user identity and authentication info.",
          "indexes": [
            {
              "columns": [
                "email"
              ],
              "reason": "Fast lookup for login",
              "type": "btree"
            }
          ],
          "relationships": [
            {
              "type": "one-to-many",
              "from": "id",
              "to": "accounts.user_id",
              "description": "User owns multiple accounts"
            }
          ]
        },
        {
          "name": "accounts",
          "columns": [
            {
              "name": "id",
              "type": "UUID",
              "constraints": [
                "PRIMARY KEY"
              ],
              "description": "Account identifier"
            },
            {
              "name": "user_id",
              "type": "UUID",
              "constraints": [
                "NOT NULL"
              ],
              "description": "Owner"
            },
            {
              "name": "balance",
              "type": "DECIMAL(19,4)",
              "constraints": [
                "NOT NULL",
                "DEFAULT 0"
              ],
              "description": "Current balance"
            },
            {
              "name": "type",
              "type": "VARCHAR(20)",
              "constraints": [
                "NOT NULL"
              ],
              "description": "checking, savings"
            }
          ],
          "description": "Financial accounts holding user funds.",
          "indexes": [
            {
              "columns": [
                "user_id"
              ],
              "reason": "Fetch all accounts for user",
              "type": "btree"
            }
          ],
          "relationships": [
            {
              "type": "many-to-one",
              "from": "user_id",
              "to": "users.id",
              "description": "Account belongs to user"
            }
          ]
        },
        {
          "name": "transactions",
          "columns": [
            {
              "name": "id",
              "type": "UUID",
              "constraints": [
                "PRIMARY KEY"
              ],
              "description": "Transaction ID"
            },
            {
              "name": "source_account_id",
              "type": "UUID",
              "constraints": [
                "NOT NULL"
              ],
              "description": "Debit account"
            },
            {
              "name": "dest_account_id",
              "type": "UUID",
              "constraints": [
                "NOT NULL"
              ],
              "description": "Credit account"
            },
            {
              "name": "amount",
              "type": "DECIMAL(19,4)",
              "constraints": [
                "NOT NULL"
              ],
              "description": "Transaction value"
            },
            {
              "name": "created_at",
              "type": "TIMESTAMP",
              "constraints": [
                "DEFAULT NOW()"
              ],
              "description": "Time of transaction"
            }
          ],
          "description": "Ledger of all money movements.",
          "indexes": [
            {
              "columns": [
                "source_account_id",
                "created_at"
              ],
              "reason": "History queries",
              "type": "btree"
            }
          ],
          "relationships": [
            {
              "type": "many-to-one",
              "from": "source_account_id",
              "to": "accounts.id",
              "description": "Source of funds"
            }
          ]
        }
      ]
    },
    "technology_stack": {
      "authentication": [
        "Passport.js",
        "JWT (JSON Web Tokens)",
        "Biometric Crypto Libs"
      ],
      "backend": [
        "Node.js",
        "NestJS",
        "TypeORM"
      ],
      "database": [
        "PostgreSQL 15",
        "Redis (Caching/Queue)"
      ],
      "frontend": [
        "React Native",
        "Redux Toolkit",
        "React Navigation"
      ],
      "hosting": [
        "AWS ECS (Fargate)",
        "AWS RDS"
      ],
      "other": [
        "Firebase Cloud Messaging",
        "Winston (Logging)",
        "Jest (Testing)"
      ]
    },
    "security_considerations": [
      "All financial data encrypted at rest using AES-256.",
      "TLS 1.3 enforced for all API communications.",
      "Biometric authentication uses cryptographic signature, not simple local flags.",
      "Rate limiting on all endpoints to prevent brute force and DDoS.",
      "Strict Content Security Policy (CSP) and OWASP headers.",
      "Database access restricted to private VPC subnets."
    ],
    "scalability_approach": {
      "caching_strategy": "Redis used to cache user sessions and frequently accessed read-only data (e.g., account types).",
      "database_scaling": "PostgreSQL configured with a primary writer and multiple read replicas. Connection pooling via PgBouncer.",
      "horizontal_scaling": "Node.js API services are stateless and auto-scaled via AWS ECS based on CPU/Memory usage.",
      "performance_targets": "API response time < 200ms for 95th percentile; Support 10,000 concurrent users."
    },
    "integration_points": [
      {
        "service": "Firebase Cloud Messaging",
        "purpose": "Send push notifications for transactions and security alerts.",
        "api_docs": "https://firebase.google.com/docs/cloud-messaging",
        "name": "FCM",
        "system": "Notification System"
      },
      {
        "service": "Core Banking System",
        "purpose": "Legacy system integration for actual fund settlement and reconciliation.",
        "api_docs": "https://internal-bank-core.com/docs",
        "name": "CoreBS",
        "system": "Banking Core"
      },
      {
        "service": "Identity Provider",
        "purpose": "KYC/AML verification for new user onboarding.",
        "api_docs": "https://id-provider.com/api",
        "name": "IDVerify",
        "system": "Compliance"
      }
    ],
    "next_tasks": [
      {
        "task": "Initialize Monorepo",
        "priority": "high",
        "assignee": "devops",
        "description": "Setup Nx or Turborepo for React Native and NestJS shared code."
      },
      {
        "task": "Design Auth Service",
        "priority": "high",
        "assignee": "engineer",
        "description": "Implement JWT issuance and Biometric signature verification logic."
      },
      {
        "task": "Setup Database Migrations",
        "priority": "high",
        "assignee": "engineer",
        "description": "Create initial TypeORM migration scripts for Users and Accounts tables."
      },
      {
        "task": "Configure CI/CD Pipeline",
        "priority": "medium",
        "assignee": "devops",
        "description": "Setup GitHub Actions for linting, testing, and Docker builds."
      },
      {
        "task": "Implement Transfer Logic",
        "priority": "medium",
        "assignee": "engineer",
        "description": "Write transactional service for internal money transfers with rollback support."
      }
    ]
  }
}