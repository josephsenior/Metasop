{
  "step_id": "arch_design",
  "role": "Architect",
  "content": {
    "design_doc": "# EduPulse Architecture Design Document\n\n## 1. System Overview\nEduPulse is a distributed e-learning platform designed for high availability and global scale. It utilizes a microservices architecture to decouple core domains: Identity, Course Management, Learning Engine, Payment, and AI-driven Analytics. The system is optimized for low-latency video delivery and real-time interactive learning experiences.\n\n## 2. Architecture Patterns\n- **Microservices Architecture**: Each domain (e.g., Billing, Content, User) is a standalone service communicating via gRPC for synchronous calls and Apache Kafka for asynchronous events.\n- **Event-Driven Architecture (EDA)**: Used for cross-service workflows like certificate generation upon course completion and updating AI recommendation models based on user activity.\n- **BFF (Backend for Frontend)**: A GraphQL gateway aggregates data from multiple microservices to provide a tailored API for the web and mobile clients, reducing round-trips.\n\n## 3. Data Flow\n1. **Content Ingestion**: Instructors upload video assets to an S3 bucket. A Lambda function triggers a transcoding pipeline (AWS Elemental MediaConvert) to generate HLS streams.\n2. **Learning Loop**: As learners watch videos, the Interactive Video Player sends heartbeat events to the Learning Engine. These events update progress in PostgreSQL and trigger 'milestone' events to Kafka.\n3. **AI Recommendations**: The AI service consumes Kafka events (course views, quiz scores) to update user embeddings in a Vector Database (Milvus), providing real-time personalized paths.\n\n## 4. Security Architecture\n- **Zero Trust**: All internal service-to-service communication is encrypted via mTLS.\n- **Identity**: Centralized Auth service using OpenID Connect (OIDC) with support for social providers.\n- **Content Protection**: Video streams are protected using Signed Cookies and DRM (Widevine/FairPlay) to prevent unauthorized downloads.\n\n## 5. Scalability Considerations\n- **Global Delivery**: CloudFront CDN caches video segments and static assets at edge locations.\n- **Database Scaling**: Read-replicas for PostgreSQL to handle high-volume search queries; Redis for session and leaderboard caching.",
    "apis": [
      {
        "path": "/api/v1/auth/register",
        "method": "POST",
        "description": "Registers a new user and initializes their learning profile.",
        "request_schema": {
          "email": "string",
          "password": "string",
          "full_name": "string",
          "preferences": "object"
        },
        "response_schema": {
          "user_id": "uuid",
          "token": "string",
          "refresh_token": "string"
        },
        "auth_required": false,
        "rate_limit": "5 requests/minute"
      },
      {
        "path": "/api/v1/courses",
        "method": "GET",
        "description": "Search and filter courses with support for full-text search and facets.",
        "request_schema": {
          "query": "string",
          "category": "string",
          "price_range": "string",
          "rating": "float",
          "page": "int"
        },
        "response_schema": {
          "results": "array",
          "total_count": "int",
          "facets": "object"
        },
        "auth_required": false,
        "rate_limit": "100 requests/minute"
      },
      {
        "path": "/api/v1/learning/progress/{course_id}",
        "method": "PATCH",
        "description": "Updates the learner's progress for a specific course module or lesson.",
        "request_schema": {
          "lesson_id": "uuid",
          "status": "string",
          "timestamp_seconds": "int"
        },
        "response_schema": {
          "progress_percentage": "float",
          "milestone_reached": "boolean"
        },
        "auth_required": true,
        "rate_limit": "200 requests/minute"
      },
      {
        "path": "/api/v1/instructor/courses",
        "method": "POST",
        "description": "Creates a new course draft for instructors.",
        "request_schema": {
          "title": "string",
          "description": "string",
          "category_id": "uuid"
        },
        "response_schema": {
          "course_id": "uuid",
          "status": "string"
        },
        "auth_required": true,
        "rate_limit": "10 requests/minute"
      },
      {
        "path": "/api/v1/certificates/{id}/verify",
        "method": "GET",
        "description": "Public endpoint to verify the authenticity of a certificate.",
        "request_schema": {},
        "response_schema": {
          "valid": "boolean",
          "learner_name": "string",
          "course_title": "string",
          "issue_date": "iso8601"
        },
        "auth_required": false,
        "rate_limit": "500 requests/minute"
      }
    ],
    "summary": "EduPulse is a microservices-based e-learning platform optimized for global scale, featuring AI-driven personalization and high-performance video delivery.",
    "description": "The architecture leverages a modern cloud-native stack (Go, Next.js, Kafka) to provide a resilient and responsive learning environment. By decoupling content delivery from user management and utilizing event-driven patterns for heavy tasks like certificate generation, EduPulse ensures a seamless experience for up to 50,000 concurrent users.",
    "decisions": [
      {
        "decision": "Use PostgreSQL with JSONB for User Preferences",
        "status": "accepted",
        "reason": "User preferences are highly dynamic and vary by learning path. JSONB allows for schema flexibility while maintaining relational integrity for core user data.",
        "rationale": "Balances flexibility with the reliability of a relational engine.",
        "tradeoffs": "Slightly higher storage overhead compared to normalized tables, but significantly reduces migration complexity.",
        "consequences": "Faster iteration on the preference wizard; requires careful indexing on JSON keys for performance.",
        "alternatives": [
          "MongoDB",
          "Normalized SQL Tables"
        ]
      },
      {
        "decision": "Adopt HLS (HTTP Live Streaming) for Video Delivery",
        "status": "accepted",
        "reason": "HLS supports adaptive bitrate streaming, ensuring smooth playback across varying network conditions (3G to Fiber).",
        "rationale": "Industry standard for high-quality, scalable video delivery.",
        "tradeoffs": "Higher latency compared to WebRTC, but better compatibility and caching support.",
        "consequences": "Requires a transcoding step for all uploaded videos.",
        "alternatives": [
          "DASH",
          "MP4 Progressive Download"
        ]
      },
      {
        "decision": "Kafka for Asynchronous Certificate Generation",
        "status": "accepted",
        "reason": "Decouples the Learning Engine from the Certificate Service. If the certificate service is down, events are persisted in Kafka and processed later.",
        "rationale": "Ensures system resilience and supports high-throughput event processing.",
        "tradeoffs": "Increases infrastructure complexity and operational overhead.",
        "consequences": "Guaranteed eventual consistency for certificate issuance.",
        "alternatives": [
          "Direct REST calls",
          "RabbitMQ"
        ]
      }
    ],
    "next_tasks": [
      {
        "role": "DevOps",
        "task": "Setup Kubernetes Cluster and CI/CD Pipelines",
        "description": "Provision EKS clusters across three regions and configure GitHub Actions for automated microservice deployment.",
        "priority": "high",
        "title": "Infrastructure Foundation"
      },
      {
        "role": "Engineer",
        "task": "Implement Video Transcoding Pipeline",
        "description": "Develop the S3-triggered Lambda function to interface with AWS Elemental MediaConvert for HLS output.",
        "priority": "high",
        "title": "Core Video Engine"
      },
      {
        "role": "Engineer",
        "task": "Develop Elasticsearch Indexing Service",
        "description": "Create a service that syncs course data from PostgreSQL to Elasticsearch for high-performance faceted search.",
        "priority": "medium",
        "title": "Search Implementation"
      },
      {
        "role": "Designer",
        "task": "Interactive Video Player UI/UX",
        "description": "Design the synchronized transcript and note-taking sidebar for the custom video player.",
        "priority": "high",
        "title": "UX Design"
      }
    ],
    "database_schema": {
      "migrations_strategy": "Versioned SQL migrations managed by Flyway or Golang Migrate.",
      "tables": [
        {
          "name": "users",
          "columns": [
            {
              "name": "id",
              "type": "uuid",
              "constraints": [
                "PK"
              ],
              "description": "Unique user identifier"
            },
            {
              "name": "email",
              "type": "varchar(255)",
              "constraints": [
                "UNIQUE",
                "NOT NULL"
              ]
            },
            {
              "name": "password_hash",
              "type": "text",
              "constraints": [
                "NOT NULL"
              ]
            },
            {
              "name": "role",
              "type": "varchar(20)",
              "description": "learner, instructor, admin"
            },
            {
              "name": "preferences",
              "type": "jsonb",
              "description": "AI-driven learning preferences"
            }
          ],
          "description": "Core user identity and profile data",
          "indexes": [
            {
              "columns": [
                "email"
              ],
              "type": "btree"
            }
          ]
        },
        {
          "name": "courses",
          "columns": [
            {
              "name": "id",
              "type": "uuid",
              "constraints": [
                "PK"
              ]
            },
            {
              "name": "instructor_id",
              "type": "uuid",
              "constraints": [
                "FK users.id"
              ]
            },
            {
              "name": "title",
              "type": "varchar(255)",
              "constraints": [
                "NOT NULL"
              ]
            },
            {
              "name": "status",
              "type": "varchar(20)",
              "description": "draft, published, archived"
            }
          ],
          "relationships": [
            {
              "type": "many-to-one",
              "from": "instructor_id",
              "to": "users.id",
              "description": "Course belongs to an instructor"
            }
          ]
        },
        {
          "name": "enrollments",
          "columns": [
            {
              "name": "id",
              "type": "uuid",
              "constraints": [
                "PK"
              ]
            },
            {
              "name": "user_id",
              "type": "uuid",
              "constraints": [
                "FK users.id"
              ]
            },
            {
              "name": "course_id",
              "type": "uuid",
              "constraints": [
                "FK courses.id"
              ]
            },
            {
              "name": "progress_pct",
              "type": "decimal(5,2)",
              "constraints": [
                "DEFAULT 0"
              ]
            },
            {
              "name": "completed_at",
              "type": "timestamp",
              "constraints": [
                "NULLABLE"
              ]
            }
          ],
          "indexes": [
            {
              "columns": [
                "user_id",
                "course_id"
              ],
              "type": "btree"
            }
          ]
        }
      ]
    },
    "technology_stack": {
      "authentication": [
        "Auth0",
        "JWT",
        "OAuth2"
      ],
      "backend": [
        "Go (High-performance services)",
        "Node.js (BFF/Gateway)",
        "Python (AI/ML)"
      ],
      "database": [
        "PostgreSQL (Primary)",
        "Redis (Cache)",
        "Elasticsearch (Search)",
        "Milvus (Vector DB)"
      ],
      "frontend": [
        "Next.js",
        "Tailwind CSS",
        "Video.js",
        "TypeScript"
      ],
      "hosting": [
        "AWS (EKS)",
        "CloudFront (CDN)",
        "S3 (Storage)"
      ],
      "other": [
        "Apache Kafka (Event Bus)",
        "gRPC (Internal RPC)",
        "Terraform (IaC)"
      ]
    },
    "integration_points": [
      {
        "service": "Stripe",
        "purpose": "Payment processing and subscription management.",
        "api_docs": "https://stripe.com/docs/api",
        "name": "Stripe Payments",
        "system": "Billing"
      },
      {
        "service": "AWS Elemental MediaConvert",
        "purpose": "Video transcoding into HLS/DASH formats.",
        "api_docs": "https://docs.aws.amazon.com/mediaconvert/",
        "name": "AWS Media Services",
        "system": "Content Pipeline"
      },
      {
        "service": "LinkedIn API",
        "purpose": "One-click certificate sharing to user profiles.",
        "api_docs": "https://learn.microsoft.com/en-us/linkedin/",
        "name": "LinkedIn Social",
        "system": "Marketing"
      }
    ],
    "security_considerations": [
      "Implementation of Widevine and FairPlay DRM for premium content protection.",
      "Strict Content Security Policy (CSP) to prevent XSS in the interactive player.",
      "Rate limiting on all public endpoints to mitigate DDoS and brute-force attacks.",
      "Encryption of PII (Personally Identifiable Information) at rest using AWS KMS."
    ],
    "scalability_approach": {
      "caching_strategy": "Multi-layer: Browser cache for assets, Redis for session/metadata, and CloudFront for global video delivery.",
      "database_scaling": "Horizontal scaling via Aurora PostgreSQL with automated read-replica promotion.",
      "horizontal_scaling": "Kubernetes HPA (Horizontal Pod Autoscaler) based on CPU and custom Kafka lag metrics.",
      "performance_targets": "Sub-500ms search latency; <2s video start time globally; 99.99% API availability."
    }
  }
}